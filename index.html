<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Stock View</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    },
                    colors: {
                        ios: {
                            bg: '#F2F2F7',
                            card: '#FFFFFF',
                            blue: '#007AFF',
                            gray: '#8E8E93',
                            separator: '#C6C6C8'
                        }
                    },
                    boxShadow: {
                        'ios': '0 4px 12px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02)',
                        'menu': '0 10px 40px rgba(0, 0, 0, 0.2)',
                        'rich': '0 20px 40px -10px rgba(0, 0, 0, 0.15)' 
                    }
                }
            }
        }
    </script>

    <style>
        /* FIX: Disable Blue Tap Highlight */
        * { -webkit-tap-highlight-color: transparent; }

        /* FIX: Prevent Native iOS Bounce (Better PTR experience) */
        body { 
            background-color: #F2F2F7; 
            -webkit-font-smoothing: antialiased; 
            touch-action: pan-y; 
            overscroll-behavior-y: none; 
        }

        /* FIX: iPhone Notch Support */
        .h-safe-top { height: env(safe-area-inset-top, 20px); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .glass { background: rgba(255, 255, 255, 0.90); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 0.5px solid rgba(0,0,0,0.05); }
        .glass-menu { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); }
        .glass-dark { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .active-scale:active { transform: scale(0.98); transition: transform 0.1s ease; }
        
        input[type="search"]::-webkit-search-decoration,
        input[type="search"]::-webkit-search-cancel-button,
        input[type="search"]::-webkit-search-results-button,
        input[type="search"]::-webkit-search-results-decoration { display: none; }
        
        .scroll-fade-wrapper { position: relative; }
        .scroll-fade-wrapper::after {
            content: ''; position: absolute; top: 0; bottom: 0; right: 0; width: 30px;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.9));
            pointer-events: none; z-index: 10;
        }

        .highlight { background-color: rgba(254, 240, 138, 0.5); font-weight: 700; color: #0f172a; border-radius: 2px; padding: 0 1px; }
        .zoom-transition { transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .zoomed { transform: scale(2.5); cursor: zoom-out; }

        #ptr-spinner { transition: transform 0.2s; }
        .rotating { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- REFINED SWIPE STYLES --- */
        .swipe-reveal-layer {
            position: absolute; top: 0; bottom: 0; right: 0; width: 100%;
            display: flex; justify-content: flex-end; z-index: 0;
        }
        .swipe-action-btn {
            height: 100%; width: 85px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;
            transition: background-color 0.3s ease;
        }
        .swipe-top-layer {
            position: relative; z-index: 10; background: white; 
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); /* Smooth Spring Return */
            will-change: transform;
        }
        .swiping-active { transition: none !important; }

        .chip { transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
        .dropdown-enter { transform: scale(0.95); opacity: 0; pointer-events: none; }
        .dropdown-active { transform: scale(1); opacity: 1; pointer-events: auto; }

        html { scroll-behavior: smooth; }
    </style>
</head>

<body class="pb-24 pt-40" id="bodyRoot">

    <div id="networkToast" class="fixed top-[120px] left-1/2 -translate-x-1/2 z-[60] flex items-center justify-center pointer-events-none transition-all duration-500 opacity-0 -translate-y-4">
        <div class="bg-slate-800/90 backdrop-blur-md text-white text-[11px] font-semibold px-4 py-1.5 rounded-full shadow-lg flex items-center gap-2">
            <i class="fa-solid fa-wifi-slash text-[10px]" id="networkIcon"></i>
            <span id="networkText">No Internet Connection</span>
        </div>
    </div>

    <header id="mainHeader" class="fixed top-0 left-0 right-0 z-50 transition-all duration-300">
        <div class="h-safe-top w-full bg-white/90 backdrop-blur-md"></div>
        
        <div class="glass pb-2 pt-4 relative z-30">
            <div id="ptr-container" class="absolute top-[-40px] left-0 right-0 flex justify-center items-center h-[40px] opacity-0 transition-opacity duration-200">
                <i id="ptr-spinner" class="fa-solid fa-arrows-rotate text-slate-400 text-sm"></i>
            </div>

            <div class="px-4 relative z-50">
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-magnifying-glass text-slate-400 text-sm"></i>
                    </div>
                    <input type="search" id="globalSearch" autocomplete="off" enterkeyhint="search" inputmode="search"
                        class="block w-full pl-9 pr-10 py-3 rounded-xl bg-slate-100/80 border-none text-slate-900 placeholder-slate-400 focus:ring-0 focus:bg-white focus:shadow-ios transition-all text-[16px] font-medium"
                        placeholder="Search Design, Surface, Body..." oninput="handleSearchInput(this.value)">
                    
                    <button id="clearSearch" class="absolute inset-y-0 right-0 w-10 flex items-center justify-center hidden active:opacity-60" onclick="clearSearch()">
                        <i class="fa-solid fa-circle-xmark text-slate-300 text-lg"></i>
                    </button>
                </div>
                <div id="searchSuggestions" class="absolute top-full left-4 right-4 mt-2 bg-white/95 backdrop-blur-xl rounded-2xl shadow-rich border border-gray-100/50 overflow-hidden hidden transition-all duration-200 origin-top z-50"></div>
            </div>

            <div class="relative mt-3 scroll-fade-wrapper">
                <div class="pl-4 pr-12 overflow-x-auto no-scrollbar flex gap-2.5 pb-2 scroll-smooth" id="sizeFilterContainer"></div>
            </div>
        </div>

        <div class="bg-white/50 backdrop-blur-sm border-b border-slate-200/50 px-5 py-2 flex justify-between items-center relative z-20">
            <span class="text-[10px] font-semibold text-slate-400 uppercase tracking-wide">
                Result: <span id="showingCount" class="text-slate-900">0</span> Units
            </span>
            <div class="relative">
                <button id="sortBtn" onclick="toggleSortMenu()" class="flex items-center gap-1.5 text-ios-blue active:opacity-50 transition-opacity">
                    <span class="text-[12px] font-semibold">Sort</span>
                    <i class="fa-solid fa-arrow-up-wide-short text-[12px]"></i>
                </button>
                <div id="sortMenu" class="absolute right-0 top-8 w-48 glass-menu rounded-xl shadow-menu border border-white/20 origin-top-right transition-all duration-200 dropdown-enter flex flex-col overflow-hidden z-[60]">
                    <button onclick="applySort('crate')" class="text-left px-4 py-3 text-[13px] font-medium text-slate-800 border-b border-gray-100 hover:bg-gray-50 active:bg-gray-100 flex justify-between items-center group">
                        By Crate No. <i id="check-crate" class="fa-solid fa-check text-ios-blue opacity-0 group-[.active]:opacity-100"></i>
                    </button>
                    <button onclick="applySort('design')" class="text-left px-4 py-3 text-[13px] font-medium text-slate-800 hover:bg-gray-50 active:bg-gray-100 flex justify-between items-center group">
                        By Design Name <i id="check-design" class="fa-solid fa-check text-ios-blue opacity-0 group-[.active]:opacity-100"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="px-3 pt-2 min-h-screen" id="mainContainer">
        <div class="columns-1 md:columns-2 lg:columns-3 gap-3 space-y-3" id="cardGrid"></div>
        
        <div id="noResults" class="hidden flex-col items-center justify-center py-24 text-center">
            <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-6 shadow-inner">
                <i class="fa-solid fa-magnifying-glass text-3xl text-slate-300"></i>
            </div>
            <h2 class="text-slate-800 font-bold text-lg">No Items Found</h2>
            <button onclick="resetFilters()" class="mt-6 px-6 py-2.5 bg-ios-blue text-white text-sm font-semibold rounded-full shadow-lg shadow-blue-200 active-scale">
                Reset Filters
            </button>
        </div>
    </main>

    <div id="imageModal" class="fixed inset-0 z-[100] hidden glass-dark flex flex-col items-center justify-center opacity-0 transition-opacity duration-300" onclick="requestCloseModal()">
        <button class="absolute top-6 right-6 w-12 h-12 bg-white/20 backdrop-blur-md rounded-full text-white flex items-center justify-center active-scale z-50 shadow-lg border border-white/10" onclick="requestCloseModal()">
            <i class="fa-solid fa-xmark text-xl"></i>
        </button>
        <div class="relative w-full h-full flex items-center justify-center overflow-hidden p-4" onclick="event.stopPropagation()">
            <div class="relative transition-transform duration-300 scale-95" id="modalContent">
                <img id="modalImage" src="" class="max-w-full max-h-[85vh] object-contain bg-white rounded-2xl shadow-2xl zoom-transition">
                <div class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/50 backdrop-blur-sm text-white/80 text-[10px] px-3 py-1 rounded-full pointer-events-none">
                    Double tap to zoom
                </div>
            </div>
        </div>
    </div>

    <button onclick="window.scrollTo({top:0, behavior:'smooth'})" class="fixed bottom-6 right-6 w-12 h-12 bg-slate-900/90 backdrop-blur-md text-white rounded-full flex items-center justify-center z-40 active-scale border border-white/10 shadow-lg">
        <i class="fa-solid fa-arrow-up text-lg"></i>
    </button>

<script>
    const DATA_CONFIG = {
        images: [
            "https://images.unsplash.com/photo-1620121474603-33c5c8d55590?ixlib=rb-4.0.3&w=800&q=80",
            "https://images.unsplash.com/photo-1616464916356-3a777b2b60b1?ixlib=rb-4.0.3&w=800&q=80",
            "https://images.unsplash.com/photo-1594818379496-da1e345b0ded?ixlib=rb-4.0.3&w=800&q=80",
            "https://images.unsplash.com/photo-1589939705384-5185137a7f0f?ixlib=rb-4.0.3&w=800&q=80",
            "https://images.unsplash.com/photo-1600607686527-6fb886090705?ixlib=rb-4.0.3&w=800&q=80"
        ],
        sizes: [
            "1600X3200X12MM", "1200X2400X9MM", "1200X2400X10MM", 
            "1200X2400X11MM", "800x3000x15mm", "800x2400x15mm", "1600x1600x9mm"
        ],
        bodies: ["REGULAR", "DARK GREY", "BROWN", "ASH GREY", "ZED BLACK", "BLACK", "GREY BODY", "L-90 WHITE"],
        surfaces: ["GRAVEL", "ILLUSION", "METTALIC", "SAHARA", "SHAPE TECH", "SOFT SATIN"],
        designs: ["LINEA STONECREMA", "PIETRA DI VALS SCURO", "RESIN MIRAG SAND", "RESIN MIRAG SCURO", "SPARKEL NERO", "PIZZARA SLATE", "LIMON STONE TAUPE", "CARARA FREDO"],
        sample: "105X205",
        prefixes: ["A", "D", "SF", "X"]
    };

    let rawData = [];
    let currentFilteredData = [];
    let activeSize = 'All';
    let pillOrder = []; 
    let currentSort = 'crate'; 
    let isUserSorted = false; 
    let displayedCount = 0;
    const BATCH_SIZE = 10;
    const TRIGGER_OFFSET = 2; 
    let observer;

    let touchStartY = 0;
    let isPulling = false;
    const PULL_THRESHOLD = 120; 

    // Swipe Variables
    let swipeStartX = 0;
    let swipeStartY = 0;
    let activeSwipeEl = null;
    let isSwipingHorizontally = false;

    function generateData() {
        rawData = Array.from({length: 100}, (_, i) => {
            const prefix = DATA_CONFIG.prefixes[Math.floor(Math.random() * DATA_CONFIG.prefixes.length)];
            const num = String(Math.floor(Math.random() * 999) + 1).padStart(3, '0');
            return {
                id: i,
                design: DATA_CONFIG.designs[i % DATA_CONFIG.designs.length], 
                size: DATA_CONFIG.sizes[i % DATA_CONFIG.sizes.length],
                surface: DATA_CONFIG.surfaces[i % DATA_CONFIG.surfaces.length],
                body: DATA_CONFIG.bodies[i % DATA_CONFIG.bodies.length],
                crate: `${prefix}-${num}`,
                sample: DATA_CONFIG.sample,
                image: DATA_CONFIG.images[i % DATA_CONFIG.images.length]
            };
        });
    }

    function init() {
        generateData();
        pillOrder = ['All', ...new Set(rawData.map(i => i.size))].sort();
        pillOrder = pillOrder.filter(x => x !== 'All'); pillOrder.unshift('All');
        renderFilters(); 
        window.fuse = new Fuse(rawData, { keys: ['design', 'surface', 'body'], threshold: 0.35, ignoreLocation: true });
        
        // FIX: Check internet immediately on load
        if (!navigator.onLine) updateNetworkStatus();

        window.addEventListener('scroll', () => {
            const input = document.getElementById('globalSearch');
            if (document.activeElement === input) { input.blur(); }
            document.getElementById('searchSuggestions').classList.add('hidden');
            
            if (activeSwipeEl && window.getComputedStyle(activeSwipeEl).transform !== 'none') {
                 closeActiveSwipe();
            }
        }, { passive: true });
        
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('sortMenu');
            const btn = document.getElementById('sortBtn');
            const suggestions = document.getElementById('searchSuggestions');
            const searchGroup = document.querySelector('.group');

            if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.remove('dropdown-active'); 
                menu.classList.add('dropdown-enter');
            }

            if (searchGroup && suggestions && !searchGroup.contains(e.target) && !suggestions.contains(e.target)) {
                suggestions.classList.add('hidden');
            }
            
             // FIX: Prevent closing if clicking the action button
             if (activeSwipeEl && !e.target.closest('.swipe-top-layer') && !e.target.closest('.swipe-action-btn')) {
                closeActiveSwipe();
            }
        });

        observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) { loadMoreData(); observer.unobserve(entry.target); }
            });
        }, { rootMargin: '100px' });

        document.getElementById('globalSearch').addEventListener('focus', () => { 
            if(document.getElementById('globalSearch').value.length > 0) {
                handleSearchInput(document.getElementById('globalSearch').value);
            }
        });

        window.addEventListener('popstate', (event) => {
            const modal = document.getElementById('imageModal');
            if (!modal.classList.contains('hidden')) {
                performCloseAnimation();
            }
        });

        window.addEventListener('offline', updateNetworkStatus);
        window.addEventListener('online', updateNetworkStatus);

        document.addEventListener('touchstart', handleTouchStart, {passive: false});
        document.addEventListener('touchmove', handleTouchMove, {passive: false});
        document.addEventListener('touchend', handleTouchEnd, {passive: true});

        const modalImg = document.getElementById('modalImage');
        let lastTap = 0;
        modalImg.addEventListener('click', (e) => {
            e.stopPropagation(); 
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 300 && tapLength > 0) {
                toggleZoom(e);
            }
            lastTap = currentTime;
        });

        applySort('crate');
    }

    function updateNetworkStatus() {
        const toast = document.getElementById('networkToast');
        const icon = document.getElementById('networkIcon');
        const text = document.getElementById('networkText');

        if (!navigator.onLine) {
            icon.className = "fa-solid fa-wifi-slash text-[10px]";
            text.innerText = "No Internet Connection";
            toast.firstElementChild.className = "bg-red-500/90 backdrop-blur-md text-white text-[11px] font-semibold px-4 py-1.5 rounded-full shadow-lg flex items-center gap-2";
            toast.classList.remove('opacity-0', '-translate-y-4');
        } else {
            icon.className = "fa-solid fa-check text-[10px]";
            text.innerText = "Back Online";
            toast.firstElementChild.className = "bg-green-500/90 backdrop-blur-md text-white text-[11px] font-semibold px-4 py-1.5 rounded-full shadow-lg flex items-center gap-2";
            setTimeout(() => {
                toast.classList.add('opacity-0', '-translate-y-4');
            }, 2000);
        }
    }

function handleTouchStart(e) {
    // 1. Touch position nikalo
    const startX = e.touches[0].clientX;
    const screenWidth = window.innerWidth;

    // --- EDGE GUARD SOLUTION (Android Back Gesture Fix) ---
    // Agar touch Left ya Right edge ke 25px area mein hai, toh hamara swipe MAT chalao.
    // Isse Android Back Gesture aur Card Swipe mein ladai nahi hogi.
    if (startX < 25 || startX > screenWidth - 25) {
        return; // Code yahi ruk jayega, system back gesture kaam karega
    }
    // -----------------------------------------------------

    if (window.scrollY === 0) {
        touchStartY = e.touches[0].clientY;
        isPulling = true;
    }

    const swipeTarget = e.target.closest('.swipe-top-layer');
    if (swipeTarget) {
        if (activeSwipeEl && activeSwipeEl !== swipeTarget) {
            closeActiveSwipe();
        }
        swipeStartX = e.touches[0].clientX;
        swipeStartY = e.touches[0].clientY;
        activeSwipeEl = swipeTarget;
        activeSwipeEl.classList.add('swiping-active');
        isSwipingHorizontally = false;
    }
}

    function handleTouchMove(e) {
        const y = e.touches[0].clientY;
        const x = e.touches[0].clientX;
        
        if (isPulling && window.scrollY <= 0) {
             const pullDistance = y - touchStartY;
             if (pullDistance > 0 && !isSwipingHorizontally) {
                const damped = Math.min(pullDistance * 0.5, 150); 
                const ptrContainer = document.getElementById('ptr-container');
                const spinner = document.getElementById('ptr-spinner');
                ptrContainer.style.opacity = Math.min(damped / 100, 1);
                ptrContainer.style.transform = `translateY(${damped}px)`;
                spinner.style.transform = `rotate(${damped * 2}deg)`;
                // Removed preventDefault here to allow native elastic scroll feel if needed, but CSS handles overscroll
             }
        }

        if (activeSwipeEl) {
            const deltaX = x - swipeStartX;
            const deltaY = y - swipeStartY;
            
            // SMART LOCK: Close if vertical scroll starts
            if (Math.abs(deltaY) > 15 && !isSwipingHorizontally) {
                closeActiveSwipe();
                return;
            }

            if (!isSwipingHorizontally && Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 10) {
                isSwipingHorizontally = true;
                isPulling = false;
            }

            if (isSwipingHorizontally) {
                if (e.cancelable) e.preventDefault(); 
                let translateX = deltaX < 0 ? deltaX * 0.6 : 0; 
                translateX = Math.max(translateX, -110);
                activeSwipeEl.style.transform = `translateX(${translateX}px)`;
            }
        }
    }

    function handleTouchEnd(e) {
        if (isPulling) {
            isPulling = false;
            const ptrContainer = document.getElementById('ptr-container');
            const spinner = document.getElementById('ptr-spinner');
            if (parseInt(ptrContainer.style.transform.replace('translateY(', '')) > 60) {
                spinner.classList.add('rotating');
                if (navigator.vibrate) navigator.vibrate(10); 
                setTimeout(() => {
                    runQuery(); 
                    spinner.classList.remove('rotating');
                    ptrContainer.style.transform = 'translateY(0px)';
                    ptrContainer.style.opacity = '0';
                }, 1000);
            } else {
                ptrContainer.style.transform = 'translateY(0px)';
                ptrContainer.style.opacity = '0';
            }
        }

        if (activeSwipeEl) {
            activeSwipeEl.classList.remove('swiping-active'); 
            const currentTransform = activeSwipeEl.style.transform;
            const translateX = currentTransform ? parseInt(currentTransform.replace('translateX(', '')) : 0;
            
            if (translateX < -55) { 
                activeSwipeEl.style.transform = 'translateX(-85px)'; 
                if (navigator.vibrate) navigator.vibrate(5); 
            } else {
                activeSwipeEl.style.transform = 'translateX(0px)';
                activeSwipeEl = null;
            }
            isSwipingHorizontally = false;
        }
    }

    function closeActiveSwipe() {
        if (activeSwipeEl) {
            activeSwipeEl.classList.remove('swiping-active');
            activeSwipeEl.style.transform = 'translateX(0px)';
            activeSwipeEl = null;
        }
    }

    function copyCardData(btnElement, event) {
        if (event) event.stopPropagation();

        // FIX: Prevent double-tap glitches
        if (btnElement.classList.contains('pointer-events-none')) return;
        btnElement.classList.add('pointer-events-none');

        const dataStr = btnElement.dataset.copyInfo;
        if (!dataStr) return;

        navigator.clipboard.writeText(dataStr).then(() => {
            if (navigator.vibrate) navigator.vibrate(25);
            
            const originalHtml = btnElement.innerHTML;
            btnElement.innerHTML = '<i class="fa-solid fa-check text-lg mb-1"></i>Copied!';
            btnElement.classList.replace('bg-ios-blue', 'bg-green-500');
            
            setTimeout(() => {
                closeActiveSwipe();
                
                setTimeout(() => {
                    btnElement.innerHTML = originalHtml;
                    btnElement.classList.replace('bg-green-500', 'bg-ios-blue');
                    btnElement.classList.remove('pointer-events-none'); // Re-enable click
                }, 400);
                
            }, 1000); 
        }).catch(() => {
             btnElement.classList.remove('pointer-events-none'); // Unlock if failed
        });
    }

    function toggleZoom(e) {
        const img = document.getElementById('modalImage');
        if (img.classList.contains('zoomed')) {
            img.classList.remove('zoomed');
        } else {
            img.classList.add('zoomed');
        }
    }

    function handleSearchInput(val) {
        isUserSorted = false; 
        handleSearch(val);
        const suggestionsBox = document.getElementById('searchSuggestions');
        if (val.trim().length === 0) { suggestionsBox.classList.add('hidden'); return; }
        const uniqueDesigns = [...new Set(rawData.map(item => item.design))];
        const matches = uniqueDesigns.filter(design => design.toLowerCase().includes(val.toLowerCase())).slice(0, 5);
        if (matches.length === 0) { suggestionsBox.classList.add('hidden'); return; }
        suggestionsBox.innerHTML = matches.map(design => `
            <div onclick="selectSuggestion('${design}')" 
                class="px-4 py-3.5 flex items-center justify-between border-b border-gray-100 last:border-0 active:bg-gray-50 transition-colors cursor-pointer group">
                <span class="text-[14px] font-medium text-slate-700 group-hover:text-ios-blue">${highlightText(design, val)}</span>
                <i class="fa-solid fa-arrow-up-right-from-square text-[10px] text-gray-300 group-hover:text-ios-blue"></i>
            </div>
        `).join('');
        suggestionsBox.classList.remove('hidden');
    }

    function highlightText(text, query) {
        if (!query || query.trim() === '') return text;
        const regex = new RegExp(`(${query.trim()})`, 'gi');
        return text.replace(regex, '<span class="highlight">$1</span>');
    }

    function selectSuggestion(designName) {
        const input = document.getElementById('globalSearch');
        input.value = designName;
        document.getElementById('searchSuggestions').classList.add('hidden');
        isUserSorted = false; 
        handleSearch(designName); 
        input.blur();
    }

    function toggleSortMenu() {
        const menu = document.getElementById('sortMenu');
        if (menu.classList.contains('dropdown-active')) { menu.classList.remove('dropdown-active'); menu.classList.add('dropdown-enter'); } 
        else { menu.classList.remove('dropdown-enter'); menu.classList.add('dropdown-active'); }
    }
    
    function applySort(type) {
        currentSort = type;
        isUserSorted = true; 
        document.getElementById('check-crate').style.opacity = type === 'crate' ? '1' : '0';
        document.getElementById('check-design').style.opacity = type === 'design' ? '1' : '0';
        document.getElementById('sortMenu').classList.remove('dropdown-active');
        document.getElementById('sortMenu').classList.add('dropdown-enter');
        runQuery(); 
    }
    
    function sortData(data) {
        if (currentSort === 'crate') {
            return data.sort((a, b) => a.crate.localeCompare(b.crate, undefined, { numeric: true, sensitivity: 'base' }));
        } else if (currentSort === 'design') {
            return data.sort((a, b) => a.design.localeCompare(b.design));
        }
        return data;
    }

    function renderFilters() {
        const container = document.getElementById('sizeFilterContainer');
        container.innerHTML = pillOrder.map(size => {
            const isSelected = size === activeSize;
            let displaySize = size === 'All' ? 'All' : `${size.split('X')[0]}x${size.split('X')[1]}`;
            const baseClass = "chip active-scale whitespace-nowrap px-4 py-2 rounded-xl text-[12px] font-bold transition-all shadow-sm border";
            const activeClass = "bg-slate-900 text-white border-slate-900 shadow-md ring-2 ring-slate-200";
            const inactiveClass = "bg-white text-slate-600 border-slate-200";
            return `<button onclick="filterBySize('${size}')" class="${baseClass} ${isSelected ? activeClass : inactiveClass}" data-size="${size}">${displaySize}</button>`;
        }).join('');
    }
    
    function filterBySize(size) {
        const isCurrentlyActive = (activeSize === size);
        const isClickingAll = (size === 'All');
        
        if (isCurrentlyActive && !isClickingAll) {
            activeSize = 'All'; 
        } else {
            activeSize = size; 
        }

        const container = document.getElementById('sizeFilterContainer');
        const buttons = container.querySelectorAll('.chip');
        
        buttons.forEach(btn => {
            const btnSize = btn.dataset.size;
            const isNowSelected = (btnSize === activeSize);
            
            btn.className = `chip active-scale whitespace-nowrap px-4 py-2 rounded-xl text-[12px] font-bold transition-all shadow-sm border ${isNowSelected ? 'bg-slate-900 text-white border-slate-900 shadow-md ring-2 ring-slate-200' : 'bg-white text-slate-600 border-slate-200'}`;
            
            if (isNowSelected) {
                if (!isCurrentlyActive || isClickingAll) {
                    if (navigator.vibrate) navigator.vibrate(5); 
                    setTimeout(() => {
                        btn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                    }, 50); 
                }
            }
        });

        runQuery();
    }
    
    function runQuery() {
        const query = document.getElementById('globalSearch').value.trim();
        let results = rawData; 
        if (activeSize !== 'All') results = results.filter(i => i.size === activeSize);
        if (query.length > 0) {
            const fuseResult = window.fuse.search(query);
            results = fuseResult.map(r => r.item).filter(i => activeSize === 'All' || i.size === activeSize);
            if (isUserSorted) { results = sortData(results); }
        } else { results = sortData(results); }
        currentFilteredData = results;
        resetGrid();
    }

    function resetGrid() {
        // FIX: Ghost Swipe Fix
        activeSwipeEl = null; 

        const grid = document.getElementById('cardGrid');
        const countEl = document.getElementById('showingCount');
        const noRes = document.getElementById('noResults');
        grid.innerHTML = ''; displayedCount = 0; window.scrollTo(0, 0); 
        countEl.innerText = currentFilteredData.length;
        if (currentFilteredData.length === 0) { noRes.classList.remove('hidden'); noRes.classList.add('flex'); return; }
        noRes.classList.add('hidden'); noRes.classList.remove('flex');
        loadMoreData(); 
    }

    function loadMoreData() {
        if (displayedCount >= currentFilteredData.length) return;
        const grid = document.getElementById('cardGrid');
        const fragment = document.createDocumentFragment();
        const nextBatch = currentFilteredData.slice(displayedCount, displayedCount + BATCH_SIZE);
        const query = document.getElementById('globalSearch').value.trim();

        nextBatch.forEach((item, index) => {
            const el = createCardElement(item, query);
            fragment.appendChild(el);
            if (index === BATCH_SIZE - TRIGGER_OFFSET && displayedCount + BATCH_SIZE < currentFilteredData.length) { observer.observe(el); }
        });
        grid.appendChild(fragment);
        displayedCount += nextBatch.length;
    }

    function createCardElement(item, query) {
        const el = document.createElement('div');
        el.className = "bg-white rounded-[16px] shadow-sm border border-slate-200 overflow-hidden relative break-inside-avoid mb-3";
        
        const displayDesign = highlightText(item.design, query);
        const displaySurface = highlightText(item.surface, query);
        const displayBody = highlightText(item.body, query);

        const subtext = `${displaySurface} â€¢ ${displayBody} â€¢ ${item.sample}`;
        let cleanSize = (item.size && item.size.includes('X')) ? `${item.size.split('X')[0]}x${item.size.split('X')[1]}` : item.size;

        // --- PREMIUM TILE FORMAT ---
        const copyString = `ðŸ“¦ Crate No: *${item.crate}*
ðŸ“ Size: *${cleanSize}*
ðŸ’  Surface: *${item.surface}*
ðŸª¨ Body: *${item.body}*
ðŸŽ¨ Design Name: *${item.design}*
âœ‚ï¸ Sample Size: *${item.sample}*`;
        // ---------------------------

el.innerHTML = `
            <div class="relative w-full h-auto overflow-hidden cursor-pointer" onclick="openModal('${item.image}')">
                <img src="${item.image}" loading="lazy" class="w-full h-auto block transition-transform duration-700 group-hover:scale-105">
            </div>
            
            <div class="relative overflow-hidden h-[65px] bg-slate-100"> 
                <div class="swipe-reveal-layer">
                    <button class="swipe-action-btn bg-ios-blue active:opacity-80" 
                            data-copy-info="${copyString}"
                            onclick="copyCardData(this, event)">
                        <i class="fa-regular fa-copy text-lg mb-1"></i>
                        Copy
                    </button>
                </div>

                <div class="swipe-top-layer flex items-stretch h-full bg-white border-t border-slate-50">
                    <div class="w-[72px] flex flex-col items-center justify-center border-r border-slate-50 shrink-0 bg-white">
                        <span class="text-[11px] font-bold text-slate-400 leading-none mb-0.5">${item.crate.split('-')[0]}</span>
                        <span class="text-[16px] font-mono font-medium text-slate-700 leading-none tracking-tighter">${item.crate.split('-')[1]}</span>
                    </div>
                    <div class="flex-1 flex flex-col items-center justify-center p-2 text-center overflow-hidden">
                        <div class="flex items-center justify-center gap-2 mb-1 w-full flex-wrap">
                            
                            <span class="text-[12px] font-bold text-slate-800 uppercase tracking-[2px]">${cleanSize}</span>
                            
                            <span class="text-[10px] text-slate-300">|</span>
                            
                          <h3 class="text-[12px] font-bold text-slate-900 truncate uppercase tracking-[1.5px]">
    ${displayDesign}
</h3>
                        </div>
                        
                       <p class="text-[9px] font-semibold text-slate-400 truncate w-full uppercase tracking-[2px]">
    ${subtext}
</p>
                    </div>
                </div>
            </div>
        `;
        return el;
    }

    function handleSearch(val) { const clearBtn = document.getElementById('clearSearch'); if(val.length > 0) clearBtn.classList.remove('hidden'); else clearBtn.classList.add('hidden'); runQuery(); }
    
    // FIX: Removed .focus() to prevent keyboard glitch
    function clearSearch() { const input = document.getElementById('globalSearch'); input.value = ''; document.getElementById('searchSuggestions').classList.add('hidden'); isUserSorted = false; handleSearch(''); }
    
    function resetFilters() { activeSize = 'All'; isUserSorted = false; filterBySize('All'); clearSearch(); document.getElementById('sizeFilterContainer').scrollLeft = 0; }
    
    function openModal(src) { 
        const modal = document.getElementById('imageModal'); 
        const content = document.getElementById('modalContent'); 
        const img = document.getElementById('modalImage');
        img.src = src; 
        img.classList.remove('zoomed'); 
        window.history.pushState({ modalOpen: true }, '', '');
        modal.classList.remove('hidden'); 
        setTimeout(() => { 
            modal.classList.remove('opacity-0'); 
            content.classList.remove('scale-100'); 
            content.classList.add('scale-100'); 
        }, 10); 
        document.body.style.overflow = 'hidden'; 
    }
    
    function requestCloseModal() { window.history.back(); }
    function performCloseAnimation() {
        const modal = document.getElementById('imageModal'); 
        const content = document.getElementById('modalContent'); 
        modal.classList.add('opacity-0'); 
        content.classList.remove('scale-100'); 
        content.classList.add('scale-95'); 
        setTimeout(() => { 
            modal.classList.add('hidden'); 
            document.body.style.overflow = ''; 
        }, 300); 
    }

    init();
</script>
</body>
</html>
